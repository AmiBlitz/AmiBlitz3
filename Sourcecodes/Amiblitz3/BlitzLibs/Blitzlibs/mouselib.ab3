; XTRA
; Embedded .xtra Header
; 
; General Info
; -------------------------------------------------------
; ExePath         = "Development:AmiBlitz3/BlitzLibs/Decompiled/baselibs"
; ExeFile         = "mouselib_new.obj"
; CreateIcon      = 0
; Residents       = "libmacs.res,libjsrs.res,LVO.res"
; 
; Compiler
; -------------------------------------------------------
; StringBuffer    = 10240
; MakeSmallest    = 1
; FuncOptimize    = 1
; Version         = 0.0.0
; NumberOfBuilds  = 18
; 
; Debugger
; -------------------------------------------------------
; CliArgs         = ""
; StackSize       = 8191
; RuntimeDebug    = 0
; DebugInfo       = 0
; CreateDbgFile   = 0
; OverflowCheck   = 1
; AssemblerCheck  = 0
; InterruptCheck  = 1
; AutoRun         = 1
; 
; Editor
; -------------------------------------------------------
; CursorLine      = 83
; CursorColumn    = 23
; LabelSearch     = "_execbase"
; LabelRemark     = 0
; LabelAll        = 1
; LabelCase       = 0
; LabelPosition   = 0
; 
; Blitz Objects
; -------------------------------------------------------
; Max File        = 5
; Max GadgetList  = 5
; Max Shape       = 100
; Max Bank        = 5
; Max MenuList    = 5
; Max GTList      = 5
; Max Palette     = 4
; Max BitMap      = 10
; Max Screen      = 5
; Max IntuiFont   = 5
; Max BlitzFont   = 4
; Max Window      = 5
; Max IconInfo    = 1
; Max MUIObject   = 50
; Max AsyncReq    = 4
; Max Req-Lib     = 5
; Max GTMenuList  = 5
; Max Console     = 5
; Max TCPSock     = 5
; Max Tape        = 5
; Max TagList     = 5
; Max Database    = 16
; Max Sound       = 10
; Max MedModule   = 8
; Max Buffer      = 10
; Max Queue       = 10
; Max Sprite      = 20
; Max Module      = 5
; Max Slice       = 10
; Max Page        = 4
; Max CopList     = 10
; Max PTModule    = 5
; Max Anim        = 10
; Max NChunky     = 50
; Max Chunky      = 20
; Max Stencil     = 5
; Max XBSound     = 10
; /XTRA

JOY0DAT  EQU $DFF00A
JOY0DATB EQU $DFF00B
INTENA   EQU $DFF09A

!libheader{#mouselib,init,0,0,errorhandling}


!astatement
!args{#word}
!libs
!subs{do_Mouse,1,0}
!name{"Mouse","On|Off"}


!astatement
!args{#word,#word}
!libs{#spriteslib,#ia3,#blitzcoplib,#ua2}
!subs{do_Pointer,chksprite+1,0}
!args
!libs
!subs{LAB_0018,1,0}
!name{"Pointer","Sprite#,Sprite Channel"}


!astatement
!args{#word,#word,#word,#word}
!libs
!subs{do_MouseArea,0,0}
!name{"MouseArea","Minx,Miny,Maxx,Maxy"}


!afunction{#quick}
!args
!libs
!subs{do_MouseX,1,0}
!name{"MouseX",""}


!afunction{#quick}
!args
!libs
!subs{do_MouseY,1,0}
!name{"MouseY",""}


!afunction{#quick}
!args
!libs
!subs{do_MouseXSpeed,1,0}
!name{"MouseXSpeed",""}


!afunction{#quick}
!args
!libs
!subs{do_MouseYSpeed,1,0}
!name{"MouseYSpeed",""}


!astatement
!args{#word,#word}
!libs
!subs{do_PositionMouse,0,0}
!name{"PositionMouse","x,y"}


init: !nullsub{initcode,0,0,#blitzcoplib,#ld0|#pd4}

!libfin
 ; ==============================================================================

mouseposx: Ds.w 1
mouseposy: Ds.w 1
oldHorizCnt: Ds.b 1
oldVertCnt: Ds.b 1
mousespeedx: Ds.w 1
mousespeedy: Ds.w 1
spriteNum: Ds.w 1
spriteChannel: Ds.w 1
area_minx: Ds.w 1
area_miny: Ds.w 1
area_maxx: Ds.w 1
area_maxy: Ds.w 1
storeA5: Ds.l 1
pointerCopList: Ds.l 1
blitzcoplib: Ds.w 1

.do_PositionMouse:
  MOVEM.w D0-D1,mouseposx
RTS

.do_MouseX:
  MOVE.w mouseposx(PC),D0
  SWAP D0
  CLR.w D0
RTS

.do_MouseY:
 MOVE.w mouseposy(PC),D0
 SWAP D0
 CLR.w D0
RTS

.do_MouseXSpeed:
 MOVE.w mousespeedx(PC),D0
 SWAP D0
 CLR.w D0
RTS

.do_MouseYSpeed:
  MOVE.w mousespeedy(PC),D0
  SWAP D0
  CLR.w D0
RTS


.initcode:
  MOVE.l A5,storeA5
  MOVE.w D0,blitzcoplib
  CLR.w area_minx
  CLR.w area_miny
  MOVE.w #$0140,area_maxx
  MOVE.w #$00c8,area_maxy
  MOVE.w #$ffff,spriteNum
RTS

.do_Pointer:
  MOVE.l A2,pointerCopList
  LSR.w #4,D0
  MOVE.w D0,spriteNum
  MOVE.w D1,spriteChannel
RTS

LAB_0018:
  MOVE.w #$ffff,spriteNum
RTS

.do_MouseArea:
  MOVE.w D0,area_minx
  MOVE.w D1,area_miny
  MOVE.w D2,area_maxx
  MOVE.w D3,area_maxy
RTS

.do_Mouse:
  TST.w D0 : BEQ.w LAB_001B
    MOVE.b JOY0DAT,oldHorizCnt
    MOVE.b JOY0DATB,oldVertCnt
    MOVE.w #$8015,D0                ; VBlank interrupt (5), other bits will be ANDed
    MOVE.l #interruptCode,D1
    BLibJsr #addanint               ;$C100 (d1: code, d0: level)
    RTS
  LAB_001B:
    MOVE.w #$8015,D0                ; VBlank interrupt (5)
    BLibJsr #clranint               ;$C101
RTS

.interruptCode:
  MOVEM.l D2-D7/A2-A4,-(A7)

  MOVE.b JOY0DATB,D1
  MOVE.b oldHorizCnt(PC),D0
  MOVE.b D1,oldHorizCnt
  SUB.b D0,D1
  EXT.w D1
  MOVE.w D1,mousespeedx

  MOVE.w mouseposx(PC),D0
  ADD.w D1,D0
  CMP.w area_minx(PC),D0 : BGE.w LAB_001D
    MOVE.w area_minx(PC),D0
    BRA.w LAB_001E
  LAB_001D:
    CMP.w area_maxx(PC),D0 : BLT.w LAB_001E
      MOVE.w area_maxx(PC),D0
      SUBQ.w #1,D0
  LAB_001E:
  MOVE.w D0,mouseposx

  MOVE.b JOY0DAT,D1
  MOVE.b oldVertCnt(PC),D0
  MOVE.b D1,oldVertCnt
  SUB.b D0,D1
  EXT.w D1
  MOVE.w D1,mousespeedy

  MOVE.w mouseposy(PC),D0
  ADD.w D1,D0
  CMP.w area_miny(PC),D0 : BGE.w LAB_001F
    MOVE.w area_miny(PC),D0
    BRA.w LAB_0020
  LAB_001F:
    CMP.w area_maxy(PC),D0 : BLT.w LAB_0020
      MOVE.w area_maxy(PC),D0
      SUBQ.w #1,D0
  LAB_0020:
  MOVE.w D0,mouseposy

  MOVE.w spriteNum(PC),D0 : BMI.w LAB_0021
    MOVE.w mouseposx(PC),D1
    MOVE.w mouseposy(PC),D2
    MOVE.w spriteChannel(PC),D3      ; spritechannel

    MOVEA.l storeA5(PC),A5
    MOVE.w blitzcoplib(PC),D4
    MOVE.w #$4000,INTENA             ; clr bit 14 of INTENA: disable MASTER Interrupt
    MOVE.l 0(A5,D4.w),-(A7)
    MOVE.l pointerCopList(PC),0(A5,D4.w)

    BLibJsr #spriteslib LSL 7 + 2 ;  $3802

    MOVE.w blitzcoplib(PC),D4
    MOVE.l (A7)+,0(A5,D4.w)
    MOVE.w #$c000,INTENA            ; set bit 14 of INTENA: enable MASTER Interrupt
  LAB_0021:
  MOVEM.l (A7)+,D2-D7/A2-A4
  MOVEQ #0,D0
RTS

; ===================================================================================================

errorhandling: MOVE.l #LAB_0025,D0 : TRAP #0
LAB_0023: MOVE.l #LAB_0026,D0 : TRAP #0
LAB_0024: MOVE.l #LAB_0027,D0 : TRAP #0

LAB_0025: Dc.b "Uninitialized Sprite",0
LAB_0026: Dc.b "Uninitialized Slice",0
LAB_0027: Dc.b "Sprite Channel Unavailable",0

.chksprite:
  TST.l (A3)   ;414: 4a93
  BEQ.w errorhandling  ;416: 6700ffa0

  TST.w (A2)   ;41a: 4a52
  BEQ.w LAB_0023  ;41c: 6700ffa2

  MOVE.w D1,D7   ;420: 3e01
  ADD.w 6(A3),D7  ;422: de6b0006
  CMP.w 6(A2),D7  ;426: be6a0006
  BHI.w LAB_0024  ;42a: 6200ff9c
RTS
