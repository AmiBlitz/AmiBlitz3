; XTRA
; Embedded .xtra Header
; 
; General Info
; -------------------------------------------------------
; ExePath         = "Blitz3:BlitzLibs/UserLibs"
; ExeFile         = "fontlib.obj"
; CreateIcon      = 0
; Residents       = "libmacs.res,libjsrs.res,blitzoffs.res,all.res"
; 
; Compiler
; -------------------------------------------------------
; StringBuffer    = 10240
; MakeSmallest    = 1
; FuncOptimize    = 1
; Version         = 0.0.0
; NumberOfBuilds  = 63
; 
; Debugger
; -------------------------------------------------------
; CliArgs         = ""
; StackSize       = 32768
; RuntimeDebug    = 0
; DebugInfo       = 0
; CreateDbgFile   = 0
; OverflowCheck   = 0
; AssemblerCheck  = 1
; InterruptCheck  = 1
; AutoRun         = 1
; 
; Editor
; -------------------------------------------------------
; CursorLine      = 197
; CursorColumn    = 24
; LabelSearch     = "btst"
; LabelRemark     = 0
; LabelAll        = 1
; LabelCase       = 0
; LabelPosition   = 0
; 
; Blitz Objects
; -------------------------------------------------------
; Max File        = 5
; Max GadgetList  = 5
; Max Shape       = 100
; Max Bank        = 5
; Max MenuList    = 5
; Max GTList      = 20
; Max Palette     = 4
; Max BitMap      = 10
; Max Screen      = 5
; Max IntuiFont   = 5
; Max Window      = 20
; Max IconInfo    = 1
; Max MUIObject   = 50
; Max AsyncReq    = 4
; Max Req-Lib     = 5
; Max GTMenuList  = 5
; Max Console     = 5
; Max TCPSock     = 5
; Max Tape        = 5
; Max TagList     = 5
; Max Database    = 16
; Max Sound       = 10
; Max MedModule   = 8
; Max Buffer      = 10
; Max Queue       = 10
; Max Sprite      = 20
; Max Module      = 5
; Max Slice       = 10
; Max Page        = 4
; Max CopList     = 10
; Max PTModule    = 5
; Max Anim        = 10
; Max NChunky     = 50
; Max Chunky      = 20
; Max Stencil     = 5
; Max XBSound     = 10
; Max BlitzFont   = 4
; /XTRA
; IRA V2.09 (06.03.18) (c)1993-1995 Tim Ruehsen
; (c)2009-2015 Frank Wille, (c)2014-2017 Nicolas Bastien

#ABSEXECBASE    = $4
;#_CloseLibrary = -414
;#;_OpenLibrary  = -552

!libheader{#fontlib,_init,0,0,errorHandler}

!astatement
!args{#word,#string}
!libs{#fontlib,#ia3,#fontlib,#ld5|#pd4,#graphicslib,#la6}
!subs{_loadblitzfont + 1,0,0}                                                   ; + 1 means only available in AMIGA-Mode
!name{"LoadBlitzFont","BlitzFont#,Fontname.font$"}

!astatement
!args{#word}
!libs{#bitmaplib,$1080}
!subs{_bitmapoutput,0,0}
!name{"BitMapOutput","Bitmap#"}

!astatement
!args{#word}
!libs
!subs{_colour2,0,0}
!args{#word,#word}
!libs
!subs{_colour,0,0}
!name{"Colour", "Foreground Colour[,Background Colour]"}


!astatement
!args{#word,#quick}
!libs
!subs{_locate,checkBitmap,0}
!name{"Locate","X,Y"}


!afunction{#quick}
!args
!libs
!subs{_cursx,checkBitmap,0}
!name{"CursX",""}

!afunction{#quick}
!args
!libs
!subs{_cursy,checkBitmap,0}
!name{"CursY",""}


!astatement
!args
!libs
!subs{_bitmapinput,1,0}
!name{"BitMapInput",""}

!astatement
!args{#word,#long}
!libs{#fontlib,#ia3, #fontlib,#ld5|#pd4}             ; #ia3 = $1380
!subs{_cludgeblitzfont + 1,0,0}
!name{"CludgeBlitzFont","BlitzFont#,Memory address"}

_init: !nullsub{_codeinit,0,0,#fontlib,$1301,#fontlib,$504,#graphicslib,#la6}
_load: !nullsub{0,0,0}
_save: !nullsub{0,0,0}
_use:  !nullsub{useFont,0,0}
_free: !nullsub{closeFont,0,0,#graphicslib,#la6}

!dumtoke{"BlitzFont","",_toke}

!nullsub{LAB_0026,0,0}
!nullsub{LAB_0029,0,0}

!libfin{_toke,_load,_save,_use,_free,4,2}  ; 4 objects by default, object size 4 bytes

; *********************************************************************
struct_TextAttr:
           Dc.w $00000000
           Dc.l $0008
           Dc.w $0000
str_topaz: Dc.b "topaz.font",0,0
oldInputchannel:  Dc.l   $00000000

_codeinit:
        CLR.l   ptr_RastPort            ;2ae: 42b90000035e
        CLR.l   ptr_TextFont            ;2b4: 42b900000362
        MOVE.w  #$0100,fgColor          ;2ba: 33fc010000000416
        MOVE.l  #str_topaz,D1           ;2c2: 223c0000029e
        BRA.w   _loadblitzfont          ;2c8: 60000034

_locate:
        MOVEA.l ptr_RastPort(PC),A0         ;2cc: 207a0090        ; bitamp ?
        LSL.w   #3,D0                   ;2d0: e748            ; X
        LSL.l   #3,D1                   ;2d2: e789            ; Y
        SWAP    D1                      ;2d4: 4841
        MOVEM.w D0-D1,40(A0)            ;2d6: 48a800030028
        RTS                             ;2dc: 4e75

_cursx:
        MOVEA.l ptr_RastPort(PC),A0     ;2de: 207a007e
        MOVEQ   #0,D0                   ;2e2: 7000
        MOVE.w  40(A0),D0               ;2e4: 30280028
        SWAP    D0                      ;2e8: 4840
        LSR.l   #3,D0                   ;2ea: e688
        RTS                             ;2ec: 4e75

_cursy:
        MOVEA.l ptr_RastPort(PC),A0     ;2ee: 207a006e
        MOVEQ   #0,D0                   ;2f2: 7000
        MOVE.w  42(A0),D0               ;2f4: 3028002a
        SWAP    D0                      ;2f8: 4840
        LSR.l   #3,D0                   ;2fa: e688
        RTS                             ;2fc: 4e75


_cludgeblitzfont:                       ; a3 = current font, d0 = blitzfont num, d1 = memory location
                                        ; a5 = Addr ??
        MOVE.l  A3,0(A5,D5.W)           
        MOVE.l  A3,ptr_TextFont         
        MOVE.l  D1,D3                   ; store address in D1, will be discarded by closefont
        BSR.w closeFont

        TST.l  D3 : BEQ.w errorOpenFont
        MOVEA.l D3,A0

        LEA    $20(A0),A0               ; skip hunk header
        MOVE.l A0,D3                    ; start of binary data in D3
        LEA    $4(A0),A0                ; skip "moveq #64,d0 rts" preceeding the struct DiskfontHeader
        LEA    $36(A0),A0               ; skip to struct TextFont

        CMPI.w  #$0008,24(A0) : BNE.w errorFontSize
        CMPI.w  #$0008,20(A0) : BNE.w errorFontSize
        BTST    #5,23(A0)     : BNE.w errorNonPropFont

        ADD.l  D3,$0A(A0)               ; reloc tf_Message/mn_Node/LN_NAME (not necessary as there is no filename in the fontdatafile)
        ADD.l  D3,$22(A0)               ; reloc tf_CharData

        TST.l  $28(A0) : BEQ.b 'skipL   ; tf_CharLoc
          ADD.l D3,$28(A0)              ; reloc 
       'skipL 

        TST.l  $2C(A0) : BEQ.b 'skipS   ; tf_CharSpace
          ADD.l D3,$2C(A0)              ; reloc
       'skipS

        TST.l  $30(A0) : BEQ.b 'skipK   ; tf_CharKern
          ADD.l D3,$30(A0)              ; reloc
       'skipK

        BSET   #7,23(A0)                ; set a propriatary flag to indicate this font has not to be closed

        MOVE.l A0,(A3)
RTS

_loadblitzfont:
        MOVE.l  A3,0(A5,D5.W)           ; current blitzfont object
        MOVE.l  A3,ptr_TextFont         ;
        MOVE.l  D1,D3                   ; string pointer to font name

        BSR.w   closeFont               ; close the current font if available

        ;-- check if topazfont is requested, if so, we use OpenFont_ if not, we have to use OpenDiskFont_
        MOVE.l A3,-(A7)
        MOVE.l D3,A3
        CMP.l   #"topa",(A3) : BNE.w usediskfont
          LEA struct_TextAttr(PC),A0  
          MOVE.l D3,(A0)                 
          JSR _OpenFont(A6)                          ;graphics.library: OpenFont_ (TextAttr) 
          BRA continue
        usediskfont:
          TST.l _diskfontBase : BNE 'l10
            BSR.w openDFLibrary
         'l10:
          MOVEA.l _diskfontBase,A6
          LEA struct_TextAttr(PC),A0
          MOVE.l D3,(A0)
          JSR _OpenDiskFont(A6)                     ;diskfont.library: OpenDiskFont_ (TextAttr)
        continue:
        MOVE.l (A7)+,A3

        TST.l   D0 : BEQ.w errorOpenFont
        MOVEA.l D0,A0                  
        CMPI.w  #$0008,24(A0) : BNE.w errorFontSize          
        CMPI.w  #$0008,20(A0) : BNE.w errorFontSize
        BTST    #5,23(A0)     : BNE.w errorNonPropFont
        MOVE.l  D0,(A3)
RTS

.closeFont:
        MOVE.l  (A3),D0 : BEQ.b skip_close
          BTST #7,23(A3) : BNE.b skip_close
            MOVEA.l D0,A1
            JSR     _CloseFont(A6)
        skip_close:
        CLR.l   (A3)
RTS

.useFont:
        MOVE.l  A3,ptr_TextFont
RTS


ptr_RastPort: Dc.l $00000000
ptr_TextFont: Dc.l $00000000

_bitmapoutput:
        MOVE.l  A0,ptr_RastPort         ;366: 23c80000035e
        LEA     LAB_0025(PC),A0         ;36c: 41fa0024
        ;JSR     SECSTRT_0-2147462652   ;370: 4eb980005204
        ALibJsr #setOutputChannel ;$5204
        RTS                             ;376: 4e75

_bitmapinput:
        LEA     LAB_0037(PC),A0         ;378: 41fa01f0
        ALibJsr #setInputChannel ; $5203

        MOVE.l  D0,oldInputchannel             ;382: 23c0000002aa
        RTS                             ;388: 4e75

        BRA.w   LAB_0029                ;38a: 60000040
        BRA.w   LAB_0026                ;38e: 60000014

LAB_0025:
        MOVEM.l D1-D7/A0-A3,-(A7)       ;392: 48e77ff0
        BSR.w   LAB_002C                ;396: 61000054
        BSR.w   LAB_0032                ;39a: 61000098
        MOVEM.l (A7)+,D1-D7/A0-A3       ;39e: 4cdf0ffe
        RTS                             ;3a2: 4e75

LAB_0026:
        MOVEM.l D1-D7/A1-A3,-(A7)       ;3a4: 48e77f70
        MOVE.l  D0,-(A7)                ;3a8: 2f00
        BEQ.w   LAB_0028                ;3aa: 67000018
        MOVEA.l A0,A2                   ;3ae: 2448
        BSR.w   LAB_002C                ;3b0: 6100003a
LAB_0027:
        MOVE.b  (A2)+,D0                ;3b4: 101a
        MOVE.l  A2,-(A7)                ;3b6: 2f0a
        BSR.w   LAB_0032                ;3b8: 6100007a
        MOVEA.l (A7)+,A2                ;3bc: 245f
        SUBQ.l  #1,(A7)                 ;3be: 5397
        BNE.w   LAB_0027                ;3c0: 6600fff2
LAB_0028:
        ADDQ.w  #4,A7                   ;3c4: 584f
        MOVEM.l (A7)+,D1-D7/A1-A3       ;3c6: 4cdf0efe
        RTS                             ;3ca: 4e75

LAB_0029:
        MOVEM.l D0/A1,-(A7)             ;3cc: 48e78040
        MOVEQ   #-1,D0                  ;3d0: 70ff
        MOVEA.l A0,A1                   ;3d2: 2248
LAB_002A:
        ADDQ.l  #1,D0                   ;3d4: 5280
        TST.b   (A1)+                   ;3d6: 4a19
        BNE.w   LAB_002A                ;3d8: 6600fffa
        TST.l   D0                      ;3dc: 4a80
        BEQ.w   LAB_002B                ;3de: 67000006
        BSR.w   LAB_0026                ;3e2: 6100ffc0
LAB_002B:
        MOVEM.l (A7)+,D0/A1             ;3e6: 4cdf0201
        RTS                             ;3ea: 4e75

LAB_002C:
        MOVE.l  ptr_RastPort(PC),D1         ;3ec: 223aff70
        BEQ.w   errorBitmap             ;3f0: 670002c0
        MOVEA.l D1,A0                   ;3f4: 2041
        TST.w   (A0)                    ;3f6: 4a50
        BEQ.w   errorBitmap             ;3f8: 670002b8
        MOVE.l  ptr_TextFont(PC),D1     ;3fc: 223aff64
        BEQ.w   errorFont               ;400: 670002b8
        MOVEA.l D1,A1                   ;404: 2241
        MOVE.l  (A1),D1                 ;406: 2211
        BEQ.w   errorFont               ;408: 670002b0
        MOVEA.l D1,A1                   ;40c: 2241
        MOVE.w  42(A0),D7               ;40e: 3e28002a
        MULS    (A0),D7                 ;412: cfd0
        RTS                             ;414: 4e75

fgColor: Dc.b $01
bgColor: Dc.b $00

_colour:
        MOVE.b  D1,bgColor           ;418: 13c100000417
_colour2:
        MOVE.b  D0,fgColor             ;41e: 13c000000416
        RTS                             ;424: 4e75

LAB_0031:
        MOVEQ   #0,D1                   ;426: 7200
        ADDQ.w  #8,D2                   ;428: 5042
        MOVE.w  (A0),D3                 ;42a: 3610
        LSL.w   #3,D3                   ;42c: e74b
        EXT.l   D3                      ;42e: 48c3
        ADD.l   D3,D7                   ;430: de83
        RTS                             ;432: 4e75

LAB_0032:
        MOVE.w  42(A0),D2               ;434: 3428002a
        CMPI.b  #$0a,D0                 ;438: 0c00000a
        BNE.w   LAB_0033                ;43c: 66000010
        BSR.w   LAB_0031                ;440: 6100ffe4
        MOVE.w  D1,40(A0)               ;444: 31410028
        MOVE.w  D2,42(A0)               ;448: 3142002a
        RTS                             ;44c: 4e75

LAB_0033:
        CMP.b   33(A1),D0               ;44e: b0290021
        BHI.w   LAB_0036                ;452: 62000110
        SUB.b   32(A1),D0               ;456: 90290020
        BMI.w   LAB_0036                ;45a: 6b000108
        MOVE.w  40(A0),D1               ;45e: 32280028
        LSR.w   #3,D1                   ;462: e649
        CMP.w   (A0),D1                 ;464: b250
        BCS.w   LAB_0034                ;466: 6500000a
        BSR.w   LAB_0031                ;46a: 6100ffba
        MOVE.w  D2,42(A0)               ;46e: 3142002a

LAB_0034:
        MOVE.w  D1,D3                   ;472: 3601
        ADDQ.w  #1,D3                   ;474: 5243
        LSL.w   #3,D3                   ;476: e74b
        MOVE.w  D3,40(A0)               ;478: 31430028
        MOVE.w  D2,D3                   ;47c: 3602
        ADDQ.w  #8,D3                   ;47e: 5043
        CMP.w   2(A0),D3                ;480: b6680002
        BHI.w   LAB_0036                ;484: 620000de
        MOVEM.l D7/A0-A1,-(A7)          ;488: 48e701c0
        EXT.l   D1                      ;48c: 48c1
        ADD.l   D1,D7                   ;48e: de81
        MOVEA.l 40(A1),A2               ;490: 24690028
        AND.w   #$00ff,D0               ;494: c07c00ff
        LSL.w   #2,D0                   ;498: e548
        MOVE.w  0(A2,D0.W),D0           ;49a: 30320000
        LSR.w   #3,D0                   ;49e: e648
        MOVE.w  38(A1),D1               ;4a0: 32290026
        MOVEA.l 34(A1),A1               ;4a4: 22690022
        ADDA.w  D0,A1                   ;4a8: d2c0
        MOVE.w  4(A0),-(A7)             ;4aa: 3f280004
        MOVE.w  (A0),D0                 ;4ae: 3010
        ADDQ.w  #8,A0                   ;4b0: 5048
        MOVE.b  fgColor(PC),D5          ;4b2: 1a3aff62
        MOVE.b  bgColor(PC),D4          ;4b6: 183aff5f

LAB_0035:
        MOVEA.l (A0)+,A2                ;4ba: 2458
        ADDA.l  D7,A2                   ;4bc: d5c7
        MOVEA.l A1,A3                   ;4be: 2649
        LSR.w   #1,D4                   ;4c0: e24c
        SCS     D3                      ;4c2: 55c3
        LSR.w   #1,D5                   ;4c4: e24d
        SCS     D2                      ;4c6: 55c2

        MOVE.b  (A3),D6                 ;4c8: 1c13
        NOT.b   D6                      ;4ca: 4606
        AND.b   D3,D6                   ;4cc: cc03
        MOVE.b  D6,(A2)                 ;4ce: 1486
        MOVE.b  (A3),D6                 ;4d0: 1c13
        AND.b   D2,D6                   ;4d2: cc02
        OR.b    D6,(A2)                 ;4d4: 8d12
        ADDA.w  D1,A3                   ;4d6: d6c1
        ADDA.w  D0,A2                   ;4d8: d4c0

        MOVE.b  (A3),D6                 ;4da: 1c13
        NOT.b   D6                      ;4dc: 4606
        AND.b   D3,D6                   ;4de: cc03
        MOVE.b  D6,(A2)                 ;4e0: 1486
        MOVE.b  (A3),D6                 ;4e2: 1c13
        AND.b   D2,D6                   ;4e4: cc02
        OR.b    D6,(A2)                 ;4e6: 8d12
        ADDA.w  D1,A3                   ;4e8: d6c1
        ADDA.w  D0,A2                   ;4ea: d4c0

        MOVE.b  (A3),D6                 ;4ec: 1c13
        NOT.b   D6                      ;4ee: 4606
        AND.b   D3,D6                   ;4f0: cc03
        MOVE.b  D6,(A2)                 ;4f2: 1486
        MOVE.b  (A3),D6                 ;4f4: 1c13
        AND.b   D2,D6                   ;4f6: cc02
        OR.b    D6,(A2)                 ;4f8: 8d12
        ADDA.w  D1,A3                   ;4fa: d6c1
        ADDA.w  D0,A2                   ;4fc: d4c0

        MOVE.b  (A3),D6                 ;4fe: 1c13
        NOT.b   D6                      ;500: 4606
        AND.b   D3,D6                   ;502: cc03
        MOVE.b  D6,(A2)                 ;504: 1486
        MOVE.b  (A3),D6                 ;506: 1c13
        AND.b   D2,D6                   ;508: cc02
        OR.b    D6,(A2)                 ;50a: 8d12
        ADDA.w  D1,A3                   ;50c: d6c1
        ADDA.w  D0,A2                   ;50e: d4c0

        MOVE.b  (A3),D6                 ;510: 1c13
        NOT.b   D6                      ;512: 4606
        AND.b   D3,D6                   ;514: cc03
        MOVE.b  D6,(A2)                 ;516: 1486
        MOVE.b  (A3),D6                 ;518: 1c13
        AND.b   D2,D6                   ;51a: cc02
        OR.b    D6,(A2)                 ;51c: 8d12
        ADDA.w  D1,A3                   ;51e: d6c1
        ADDA.w  D0,A2                   ;520: d4c0

        MOVE.b  (A3),D6                 ;522: 1c13
        NOT.b   D6                      ;524: 4606
        AND.b   D3,D6                   ;526: cc03
        MOVE.b  D6,(A2)                 ;528: 1486
        MOVE.b  (A3),D6                 ;52a: 1c13
        AND.b   D2,D6                   ;52c: cc02
        OR.b    D6,(A2)                 ;52e: 8d12
        ADDA.w  D1,A3                   ;530: d6c1
        ADDA.w  D0,A2                   ;532: d4c0

        MOVE.b  (A3),D6                 ;534: 1c13
        NOT.b   D6                      ;536: 4606
        AND.b   D3,D6                   ;538: cc03
        MOVE.b  D6,(A2)                 ;53a: 1486
        MOVE.b  (A3),D6                 ;53c: 1c13
        AND.b   D2,D6                   ;53e: cc02
        OR.b    D6,(A2)                 ;540: 8d12
        ADDA.w  D1,A3                   ;542: d6c1
        ADDA.w  D0,A2                   ;544: d4c0

        MOVE.b  (A3),D6                 ;546: 1c13
        NOT.b   D6                      ;548: 4606
        AND.b   D3,D6                   ;54a: cc03
        MOVE.b  D6,(A2)                 ;54c: 1486
        MOVE.b  (A3),D6                 ;54e: 1c13
        AND.b   D2,D6                   ;550: cc02
        OR.b    D6,(A2)                 ;552: 8d12
        ADDA.w  D1,A3                   ;554: d6c1
        ADDA.w  D0,A2                   ;556: d4c0

        SUBQ.w  #1,(A7)                 ;558: 5357
        BNE.w   LAB_0035                ;55a: 6600ff5e
        ADDQ.w  #2,A7                   ;55e: 544f
        MOVEM.l (A7)+,D7/A0-A1          ;560: 4cdf0380
LAB_0036:
        RTS                             ;564: 4e75
        BRA.w   LAB_0038                ;566: 60000008

LAB_0037:
        MOVEA.l oldInputchannel(PC),A6         ;56a: 2c7afd3e
        JMP     (A6)                    ;56e: 4ed6

LAB_0038:
        MOVEM.l D1-D7/A1/A4-A5,-(A7)    ;570: 48e77f4c
        MOVEA.l A0,A5                   ;574: 2a48
        MOVE.w  D0,D6                   ;576: 3c00
        MOVEA.l ptr_RastPort(PC),A4         ;578: 287afde4
        MOVEQ   #0,D7                   ;57c: 7e00
LAB_0039:
        BSR.w   LAB_0048                ;57e: 610000d6
LAB_003A:
        BSR.w   LAB_0049                ;582: 610000f2
LAB_003B:
        BSR.w   LAB_0037                ;586: 6100ffe2
        CMPI.w  #$ffff,D0               ;58a: 0c40ffff
        BEQ.w   LAB_003B                ;58e: 6700fff6
        MOVE.w  D0,-(A7)                ;592: 3f00
        BSR.w   LAB_0049                ;594: 610000e0
        MOVE.w  (A7)+,D0                ;598: 301f
        CMPI.w  #$0020,D0               ;59a: 0c400020
        BCS.w   LAB_003F                ;59e: 65000034
        CMPI.w  #$007e,D0               ;5a2: 0c40007e
        BHI.w   LAB_003F                ;5a6: 6200002c
        MOVE.w  D6,D5                   ;5aa: 3a06
LAB_003C:
        SUBQ.w  #1,D5                   ;5ac: 5345
        CMP.w   D7,D5                   ;5ae: ba47
        BLS.w   LAB_003D                ;5b0: 6300000c
        MOVE.b  -1(A5,D5.W),0(A5,D5.W)  ;5b4: 1bb550ff5000
        BRA.w   LAB_003C                ;5ba: 6000fff0
LAB_003D:
        MOVE.b  D0,0(A5,D7.W)           ;5be: 1b807000
        BSR.w   LAB_0048                ;5c2: 61000092
LAB_003E:
        ADDQ.w  #1,D7                   ;5c6: 5247
        CMP.w   D6,D7                   ;5c8: be46
        BCS.w   LAB_003A                ;5ca: 6500ffb6
        SUBQ.w  #1,D7                   ;5ce: 5347
        BRA.w   LAB_003A                ;5d0: 6000ffb0

LAB_003F:
        CMPI.w  #$001f,D0               ;5d4: 0c40001f
        BEQ.w   LAB_0040                ;5d8: 67000026
        CMPI.w  #$001e,D0               ;5dc: 0c40001e
        BEQ.w   LAB_003E                ;5e0: 6700ffe4
        CMPI.w  #$000d,D0               ;5e4: 0c40000d
        BEQ.w   LAB_0045                ;5e8: 6700004c
        CMPI.w  #$007f,D0               ;5ec: 0c40007f
        BEQ.w   LAB_0042                ;5f0: 67000026
        CMPI.w  #$0008,D0               ;5f4: 0c400008
        BEQ.w   LAB_0041                ;5f8: 67000012
        BRA.w   LAB_003A                ;5fc: 6000ff84
LAB_0040:
        SUBQ.w  #1,D7                   ;600: 5347
        BPL.w   LAB_003A                ;602: 6a00ff7e
        ADDQ.w  #1,D7                   ;606: 5247
        BRA.w   LAB_003A                ;608: 6000ff78
LAB_0041:
        SUBQ.w  #1,D7                   ;60c: 5347
        BPL.w   LAB_0042                ;60e: 6a000008
        ADDQ.w  #1,D7                   ;612: 5247
        BRA.w   LAB_003A                ;614: 6000ff6c

LAB_0042:
        MOVE.w  D7,D0                   ;618: 3007
LAB_0043:
        ADDQ.w  #1,D0                   ;61a: 5240
        CMP.w   D6,D0                   ;61c: b046
        BCC.w   LAB_0044                ;61e: 6400000c
        MOVE.b  0(A5,D0.W),-1(A5,D0.W)  ;622: 1bb5000000ff
        BRA.w   LAB_0043                ;628: 6000fff0
LAB_0044:
        MOVE.b  #$20,-1(A5,D6.W)        ;62c: 1bbc002060ff
        BRA.w   LAB_0039                ;632: 6000ff4a
LAB_0045:
        MOVEQ   #0,D0                   ;636: 7000
        MOVE.w  D6,D0                   ;638: 3006
LAB_0046:
        BEQ.w   LAB_0047                ;63a: 67000012
        CMPI.b  #$20,-1(A5,D0.W)        ;63e: 0c35002000ff
        BNE.w   LAB_0047                ;644: 66000008
        SUBQ.w  #1,D0                   ;648: 5340
        BRA.w   LAB_0046                ;64a: 6000ffee
LAB_0047:
        MOVEA.l A5,A0                   ;64e: 204d
        MOVEM.l (A7)+,D1-D7/A1/A4-A5    ;650: 4cdf32fe
        RTS                             ;654: 4e75
LAB_0048:
        MOVE.l  40(A4),-(A7)            ;656: 2f2c0028
        MOVE.w  D7,D0                   ;65a: 3007
        LSL.w   #3,D0                   ;65c: e748
        ADD.w   D0,40(A4)               ;65e: d16c0028
        MOVEA.l A5,A0                   ;662: 204d
        ADDA.w  D7,A0                   ;664: d0c7
        MOVEQ   #0,D0                   ;666: 7000
        MOVE.w  D6,D0                   ;668: 3006
        SUB.w   D7,D0                   ;66a: 9047
        BSR.w   LAB_0026                ;66c: 6100fd36
        MOVE.l  (A7)+,40(A4)            ;670: 295f0028
        RTS                             ;674: 4e75
LAB_0049:
        MOVE.w  40(A4),D1               ;676: 322c0028
        LSR.w   #3,D1                   ;67a: e649
        ADD.w   D7,D1                   ;67c: d247
        EXT.l   D1                      ;67e: 48c1
        MOVE.w  42(A4),D0               ;680: 302c002a
        MULU    (A4),D0                 ;684: c0d4
        ADD.l   D1,D0                   ;686: d081
        MOVEQ   #7,D1                   ;688: 7207
LAB_004A:
        LEA     8(A4),A0                ;68a: 41ec0008
        MOVE.w  4(A4),D2                ;68e: 342c0004
        SUBQ.w  #1,D2                   ;692: 5342
LAB_004B:
        MOVEA.l (A0)+,A1                ;694: 2258
        ADDA.l  D0,A1                   ;696: d3c0
        NOT.b   (A1)                    ;698: 4611
        DBF     D2,LAB_004B             ;69a: 51cafff8
        MOVEA.l D0,A1                   ;69e: 2240
        ADDA.w  (A4),A1                 ;6a0: d2d4
        MOVE.l  A1,D0                   ;6a2: 2009
        DBF     D1,LAB_004A             ;6a4: 51c9ffe4
        RTS                             ;6a8: 4e75

openDFLibrary:
        LEA str_diskfontlib(pc),A1
        MOVEQ #0,d0
        MOVE.l ABSEXECBASE,A6
        JSR _OpenLibrary(a6)              ; open powerpc.library
        TST.l d0 : BEQ errorLibrary
        MOVE.l d0,_diskfontBase
        RTS

closeDFLibrary:
        MOVE.l _diskfontBase(pc),d0
        BEQ nc2
          MOVE.l d0,a1
          MOVE.l ABSEXECBASE,a6
          JSR _CloseLibrary(a6)
          CLR.l _diskfontBase
        nc2:
        RTS


_diskfontBase:   Dc.l 0
str_diskfontlib: Dc.b "diskfont.library",0,0

; ************************** Errorhandling
errorHandler:
errorOpenFont:   MOVE.l #message1,D0 : TRAP #0
errorBitmap:     MOVE.l #message2,D0 : TRAP #0
errorFont:       MOVE.l #message3,D0 : TRAP #0                      
errorLibrary:    MOVE.l #message4,D0 : TRAP #0
errorFontSize:   MOVE.l #message5,D0 : TRAP #0
errorNonPropFont:MOVE.l #message6,D0 : TRAP #0
message1: Dc.b "Can't Open Font",0
message2: Dc.b "Uninitialized BitMap",0,0
message3: Dc.b "Uninitialized Font",0,0
message4: Dc.b "Can't open diskfont.library",0
message5: Dc.b "The font must be a 8x8 one",0,0
message6: Dc.b "The font must be propotional",0,0

unusedcheck:
        TST.w   (A0)                    ;6fa: 4a50
        BEQ.w   errorBitmap                ;6fc: 6700ffb4
        RTS                             ;700: 4e75

checkBitmap:
        MOVEA.l ptr_RastPort(PC),A0         ;702: 207afc5a
        TST.w   (A0)                    ;706: 4a50
        BEQ.w   errorBitmap                ;708: 6700ffa8
        RTS                             ;70c: 4e75
