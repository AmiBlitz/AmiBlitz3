; XTRA
; Embedded .xtra Header
; 
; General Info
; -------------------------------------------------------
; ExePath         = "Blitz3:BlitzLibs/Decompiled/baselibs"
; ExeFile         = "intlib_new.obj"
; CreateIcon      = 0
; Residents       = "libmacs.res,libnums.res,libjsrs.res"
; 
; Compiler
; -------------------------------------------------------
; StringBuffer    = 10240
; MakeSmallest    = 1
; FuncOptimize    = 1
; Version         = 0.0.0
; NumberOfBuilds  = 98
; 
; Debugger
; -------------------------------------------------------
; CliArgs         = ""
; StackSize       = 8191
; RuntimeDebug    = 0
; DebugInfo       = 0
; CreateDbgFile   = 0
; OverflowCheck   = 0
; AssemblerCheck  = 0
; InterruptCheck  = 1
; AutoRun         = 1
; 
; Editor
; -------------------------------------------------------
; CursorLine      = 225
; CursorColumn    = 1
; LabelSearch     = "globalfree"
; LabelRemark     = 0
; LabelAll        = 1
; LabelCase       = 0
; LabelPosition   = 0
; 
; Blitz Objects
; -------------------------------------------------------
; Max File        = 5
; Max GadgetList  = 5
; Max Shape       = 100
; Max Bank        = 5
; Max MenuList    = 5
; Max GTList      = 20
; Max BitMap      = 10
; Max Screen      = 5
; Max IntuiFont   = 5
; Max Window      = 20
; Max Palette     = 4
; Max BlitzFont   = 4
; Max IconInfo    = 1
; Max MUIObject   = 50
; Max AsyncReq    = 4
; Max Req-Lib     = 5
; Max GTMenuList  = 5
; Max Console     = 5
; Max TCPSock     = 5
; Max Tape        = 5
; Max TagList     = 5
; Max Database    = 16
; Max Sound       = 10
; Max MedModule   = 8
; Max Buffer      = 10
; Max Queue       = 10
; Max Sprite      = 20
; Max Module      = 5
; Max Slice       = 10
; Max Page        = 4
; Max CopList     = 10
; Max PTModule    = 5
; Max Anim        = 10
; Max NChunky     = 50
; Max Chunky      = 20
; Max Stencil     = 5
; Max XBSound     = 10
; /XTRA
; IRA V2.09 (06.03.18) (c)1993-1995 Tim Ruehsen
; (c)2009-2015 Frank Wille, (c)2014-2017 Nicolas Bastien
#intlib      = 65520
#ABSEXECBASE = $4
#VPOSR       = $DFF005

;syslibheader{libnum,firsttoke,lasttoke+1,init,return,finit,error[,flags]}
!syslibheader{#intlib,$c100   ,$c108     ,init,     0,    0,     0,0}

!nullsub{AddAnInt,0,0} ;c100
!nullsub{ClrAnInt,0,0} ;c101
!nullsub{restoreA5,0,0} ;c102
!nullsub{onlyReturn,0,0} ;c103
!nullsub{_vwait,0,0,#graphicslib,#la6} ; c104
!nullsub{_freeAllInterrupts,0,0} ;c105
!nullsub{_registerAllBlitzInterrupts,0,0} ;c106
!nullsub{_clearAllBlitzInterrupts,0,0} ;c107

init: !nullsub{codeinit,0,0}
!libfin

; ============================================================================0

skipIntServer: Dc.w $0000
storeA5:  Dc.l $00000000

intListAmigaMode: Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000

intListBlitzMode: Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000
          Dc.l $00000000

currentIntList: Dc.l $00000000
interruptsAlreadyRegistered: Dc.l $00000000


_vwait:
  Dc.w $a001 : Dc.l _vwaitBlitz

  MOVE.w D0,D2
  LAB_0009:
    JSR -270(A6)      ; _WaitTOF
  DBF D2,LAB_0009
RTS
  
_vwaitBlitz:
    BTST #0,VPOSR : BEQ.w _vwaitBlitz
  
    LAB_000B:
      BTST #0,VPOSR : BNE.w LAB_000B
  
  DBF D0,_vwaitBlitz
RTS


.codeinit:
  CLR.w interruptsAlreadyRegistered        ;1ac: 427900000178
  LEA intListAmigaMode(PC),A0   ;1b2: 41faff40
  MOVEQ #31,D0            ;1b6: 701f
  LAB_000D:
    CLR.l (A0)+           ;1b8: 4298
  DBF D0,LAB_000D         ;1ba: 51c8fffc
  MOVE.l A5,storeA5    ;1be: 23cd000000f0
RTS                       ;1c4: 4e75



_freeAllInterrupts:
  LEA intListAmigaMode(PC),A2
  BSR.w removeAllInterrupts
  
  TST.w interruptsAlreadyRegistered : BEQ.w LAB_000F
    LEA intListBlitzMode(PC),A2
    BSR.w removeAllInterrupts
  LAB_000F:

  LEA intListAmigaMode(PC),A2     ; clear both interruptlists
  MOVEQ #31,D2            ;1e4: 741f
  LAB_0010:
    MOVE.l (A2)+,D0       ;1e6: 201a
    BEQ.w LAB_0012        ;1e8: 6700001a
      CLR.l -4(A2)        ;1ec: 42aafffc
      LAB_0011:
        MOVEA.l D0,A3     ;1f0: 2640
        MOVE.l (A3),-(A7) ;1f2: 2f13
        MOVEA.l A3,A1     ;1f4: 224b
        MOVEQ #28,D0      ;1f6: 701c
        ALibJsr #globalfree  ;$C003
        MOVE.l (A7)+,D0   ;1fe: 201f
      BNE.w LAB_0011      ;200: 6600ffee
    LAB_0012:
  DBF D2,LAB_0010         ;204: 51caffe0
RTS                       ;208: 4e75

.addAllInterrupts:
  MOVEA.l ABSEXECBASE,A6
  MOVEQ #15,D2
  LAB_0014:
    MOVE.l (A2)+,D0 : BEQ.w LAB_0016
      LAB_0015:
        MOVEA.l D0,A3
        LEA 6(A3),A1      ; pointer to interrupt server node
        MOVE.w 4(A3),D0
        AND.l #$0000000f,D0
        JSR -168(A6)      ; AddIntServer(D0-0:4 :intNum, A1:interrupt
        MOVE.l (A3),D0
      BNE.w LAB_0015
    LAB_0016:
  DBF D2,LAB_0014
RTS

.removeAllInterrupts:
  MOVEA.l ABSEXECBASE,A6
  MOVEQ #15,D2
  LAB_0018:
    MOVE.l (A2)+,D0 : BEQ.w LAB_001A
      LAB_0019:
        MOVEA.l D0,A3
        LEA 6(A3),A1      ; pointer to interrupt server node
        MOVE.w 4(A3),D0
        AND.l #$0000000f,D0
        JSR -174(A6)      ; RemIntServer(D0: intNumer, A1:interrupt)
        MOVE.l (A3),D0
      BNE.w LAB_0019
    LAB_001A:
  DBF D2,LAB_0018
RTS

restoreA5:
  MOVEA.l storeA5(PC),A5
RTS

onlyReturn:
RTS

blitzAddAnInt:
  MOVE.l #intListBlitzMode,currentIntList ;26e: 23fc0000013400000174
  TST.w interruptsAlreadyRegistered : SEQ skipIntServer
  BRA.w LAB_001F
  
.AddAnInt:
  Dc.w $a001 : Dc.l blitzAddAnInt
  MOVE.l #intListAmigaMode,currentIntList ;28e: 23fc000000f400000174
  CLR.w skipIntServer

  LAB_001F:
  MOVEM.l D2/A0-A1/A6,-(A7)

  MOVEM.l D0-D1,-(A7)       ; allocate memory for struct interrupt
  MOVEQ #28,D0
  MOVE.l #$00010001,D1
  ALibJsr #globalalloc
  MOVEA.l D0,A1
  MOVEM.l (A7)+,D0-D1

  MOVEA.l currentIntList(PC),A0
  MOVE.w D0,D2
  AND.w #$000f,D2
  LSL.w #2,D2
  ADDA.w D2,A0
  MOVE.l (A0),(A1)            ; interrupt\is_Node
  MOVE.l A1,(A0)
  ADDQ.w #4,A1
  MOVE.w D0,(A1)+             ; interrupt\is_Node\ln_Type, interrupt\is_Node\ln_Pri (provided by compiler)
  MOVE.l D1,18(A1)            ; interrupt\*is_Code (provided by compiler in "do_SetInt")
  MOVE.B #$02,8(A1)

  TST.w skipIntServer : BNE.w LAB_0020
    MOVEA.l ABSEXECBASE,A6
    AND.l #$0000000f,D0  ;AddIntServer (D0:intNum, A1:interrupt)
    JSR -168(A6)
  LAB_0020:

  MOVEM.l (A7)+,D2/A0-A1/A6
RTS

blitzClrAnInt:
  MOVE.l #intListBlitzMode,currentIntList
  TST.w interruptsAlreadyRegistered : SEQ skipIntServer
  BRA.w LAB_0023

.ClrAnInt:
  Dc.w $a001 : Dc.l blitzClrAnInt
  MOVE.l #intListAmigaMode,currentIntList ;31a: 23fc000000f400000174
  CLR.w skipIntServer

  LAB_0023:
  MOVEM.l D1-D2/A0-A3/A6,-(A7) ;32a: 48e760f2
  MOVE.w D0,D2
  AND.w #$000f,D0
  LSL.w #2,D0
  MOVEA.l currentIntList(PC),A2
  LEA 0(A2,D0.w),A3

  LAB_0024:
    MOVE.l (A3),D1 : BEQ.w LAB_0027
      MOVEA.l D1,A2
      CMP.w 4(A2),D2 : BEQ.w LAB_0025
        MOVEA.l A2,A3
    BRA.w LAB_0024
    LAB_0025:

    TST.w skipIntServer : BNE.w LAB_0026
      LEA 6(A2),A1
      MOVE.w D2,D0
      AND.l #$0000000f,D0
      MOVEA.l ABSEXECBASE,A6
      JSR -174(A6)          ;RemIntServer(D0:intNumber, A1:interrupt)
    LAB_0026:

    MOVEA.l A2,A1
    MOVE.l (A2),(A3)
    MOVEQ #28,D0
    ALibJsr #globalfree     ;$c003
  BRA.w LAB_0024
  LAB_0027:

  MOVEM.l (A7)+,D1-D2/A0-A3/A6
RTS

_registerAllBlitzInterrupts:
  TST.w interruptsAlreadyRegistered : BNE.w LAB_0029
    ST interruptsAlreadyRegistered  ;394: 50f900000178
    MOVEM.l D0-D2/A0-A3/A6,-(A7) ;39a: 48e7e0f2
    LEA intListBlitzMode(PC),A2 ;39e: 45fafd94
    BSR.w addAllInterrupts  ;3a2: 6100fe66
    MOVEM.l (A7)+,D0-D2/A0-A3/A6 ;3a6: 4cdf4f07
  LAB_0029:
RTS    ;3aa: 4e75

_clearAllBlitzInterrupts:
  TST.w interruptsAlreadyRegistered : BEQ.w LAB_002B
    SF interruptsAlreadyRegistered  ;3b6: 51f900000178
    MOVEM.l D0-D2/A0-A3/A6,-(A7) ;3bc: 48e7e0f2
    LEA intListBlitzMode(PC),A2 ;3c0: 45fafd72
    BSR.w removeAllInterrupts  ;3c4: 6100fe72
    MOVEM.l (A7)+,D0-D2/A0-A3/A6 ;3c8: 4cdf4f07
  LAB_002B:
RTS    ;3cc: 4e75
