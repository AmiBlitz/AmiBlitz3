; XTRA
; Embedded .xtra Header
; 
; General Info
; -------------------------------------------------------
; ExePath         = "Development:AmiBlitz3/BlitzLibs/Decompiled/baselibs"
; ExeFile         = "spriteslib_new.obj"
; CreateIcon      = 0
; Residents       = "LVO.res,libmacs.res,libnums.res"
; 
; Compiler
; -------------------------------------------------------
; StringBuffer    = 10240
; MakeSmallest    = 1
; FuncOptimize    = 1
; Version         = 3.9.7
; NumberOfBuilds  = 188
; 
; Debugger
; -------------------------------------------------------
; CliArgs         = ""
; StackSize       = 8191
; RuntimeDebug    = 0
; DebugInfo       = 0
; CreateDbgFile   = 0
; OverflowCheck   = 1
; AssemblerCheck  = 1
; InterruptCheck  = 1
; AutoRun         = 1
; 
; Editor
; -------------------------------------------------------
; CursorLine      = 64
; CursorColumn    = 25
; LabelSearch     = "lab_000b"
; LabelRemark     = 0
; LabelAll        = 1
; LabelCase       = 0
; LabelPosition   = 0
; 
; Blitz Objects
; -------------------------------------------------------
; Max File        = 5
; Max GadgetList  = 50
; Max Shape       = 100
; Max Bank        = 5
; Max MenuList    = 50
; Max GTList      = 50
; Max Palette     = 4
; Max BitMap      = 10
; Max Screen      = 5
; Max IntuiFont   = 5
; Max BlitzFont   = 4
; Max Window      = 50
; Max IconInfo    = 1
; Max MUIObject   = 50
; Max AsyncReq    = 4
; Max Req-Lib     = 5
; Max GTMenuList  = 30
; Max Console     = 5
; Max TCPSock     = 5
; Max Tape        = 5
; Max Sound       = 10
; Max MedModule   = 8
; Max Buffer      = 10
; Max Queue       = 10
; Max Sprite      = 20
; Max Module      = 5
; Max Slice       = 10
; Max Page        = 4
; Max CopList     = 10
; Max PTModule    = 5
; Max Anim        = 10
; Max NChunky     = 50
; Max Chunky      = 20
; Max Stencil     = 5
; Max XBSound     = 10
; /XTRA
; IRA V2.09 (06.03.18) (c)1993-1995 Tim Ruehsen
; (c)2009-2015 Frank Wille, (c)2014-2017 Nicolas Bastien

!libheader{#spriteslib,init,3,0,errors}

!astatement
!args{#word,#word}
!libs{#spriteslib,#ia3,#shapeslib,$1281}
!subs{do_GetaSprite,LAB_003D,0}
!name{"GetaSprite","Sprite#,Shape#"}

!astatement
!args{#word,#word,#word,#word}
!libs{#spriteslib,#ia3,#blitzcoplib,#ua2}
!subs{do_ShowSprite,LAB_003F+1,0}
!name{"ShowSprite","Sprite#,X,Y,Sprite Channel"}  ;$3802

!astatement
!args{#word}
!libs{#blitzcoplib,#ua2}
!subs{do_InFrontB,LAB_0040+1,0}
!name{"InFront","Sprite Channel"}

!astatement
!args{#word}
!libs{#blitzcoplib,#ua2}
!subs{do_InFrontF,LAB_0040+1,0}
!name{"InFrontF","Sprite Channel"}

!astatement
!args{#word}
!libs{#blitzcoplib,#ua2}
!subs{do_InFrontB,LAB_0040+1,0}
!name{"InFrontB","Sprite Channel"}

!astatement
!args{#word,#word,#string}
!libs{#spriteslib,#ia3|#pd0,#spriteslib,#ia2|#pd1,#doslib,#la6}
!subs{do_SaveSprites+1,LAB_0041,0}
!name{"SaveSprites","Sprite#,Sprite#,Filename$"}

!astatement
!args{#word,#string}
!libs{#spriteslib,#ia3,#spriteslib,$1201,#spriteslib,#md2,#doslib,#la6}
!subs{do_LoadSprites+1,0,0}
!args{#word,#word,#string}
!libs{#spriteslib,#ia3,#spriteslib,$1281,#doslib,#la6}
!subs{do_LoadSprites2+1,LAB_0041,0}
!name{"LoadSprites","Sprite#[,Sprite#],Filename$"}

!astatement
!args{#word}
!libs
!subs{do_SpriteMode,0,0}
!name{"SpriteMode","0=16 1=32 2=64"}

!dumtoke{"Sprite","",_toke}

init:  !nullsub{_codeinit,0,0}
_load: !nullsub{0,0,0}
_save: !nullsub{0,0,0}
_use:  !nullsub{0,0,0}
_free: !nullsub{free_currentSprite,0,0}
!libfin{_toke,_load,_save,_use,_free,20,4} ;128 bytes for a mycop entry

; ***************************************************************************************************************
_codeinit:
  MOVE.w #$0000,_spriteMode
  MOVE.w #$0002,LAB_000C
  MOVE.w #$0002,LAB_000B
  MOVE.l #_spriteMode,D0
RTS

.do_SpriteMode:
  MOVE.w D0,_spriteMode
  ADDQ.w #2,D0
  MOVE.w D0,LAB_000C
  SUBQ.w #2,D0
  ADD.w D0,D0
  MOVE.w LAB_0009(PC,D0.w),LAB_000B
RTS

LAB_0009: Dc.w $0002
          Dc.w $0004
          Dc.w $0008
_spriteMode: Ds.w 1
LAB_000B: Ds.w 1
LAB_000C: Ds.w 1

.do_SaveSprites:
  MOVE.L D2,D1
  MOVE.L #$000003ee,D2
  JSR _Open(A6)
  MOVE.L D0,D7 : BEQ.W error_open

  LAB_000Ea:
    MOVE.L D7,D1   
    MOVE.L A3,D2   
    MOVEQ #16,D3   
    JSR _Write(A6) 
    CMPI.L #$00000010,D0 : BNE.W error_access

    MOVE.L (A3),D2 : BEQ.W LAB_000Fa 
      MOVE.W 4(A3),D3
      MOVE.W LAB_000C(PC),D0
      LSL.W D0,D3  
      MULU 6(A3),D3
      MOVE.L D3,D4 
      MOVE.L D7,D1 
      JSR _Write(A6)
      CMP.L D4,D0 : BNE.W error_access
    LAB_000Fa:

    LEA 16(A3),A3
    CMPA.L A2,A3
  BLS.W LAB_000Ea
  MOVE.L D7,D1
JMP _Close(A6)

.do_LoadSprites:
  SUBQ.W #1,D2
  LSL.W #4,D2 
  ADDA.W D2,A2
  MOVE.L D1,D2
.do_LoadSprites2:
  MOVE.L D2,D1
  MOVE.L #$000003ed,D2
  JSR _Open(A6)
  MOVE.L D0,D7 : BEQ.W error_open

  LAB_0012a:
    BSR.W free_currentSprite
    MOVE.L D7,D1  
    MOVE.L A3,D2  
    MOVEQ #16,D3  
    JSR _Read(A6) 
    TST.L D0 : BEQ.W LAB_0014a

    CMPI.L #$00000010,D0 : BNE.W error_access

    TST.L (A3) : BEQ.W LAB_0013a
      MOVE.W 4(A3),D3
      MOVE.W LAB_000C(PC),D0
      LSL.W D0,D3
      MULU 6(A3),D3
      MOVE.L D3,D0 
      MOVEQ #2,D1  
      ALibJsr #globalalloc
      MOVE.L D0,(A3)
      MOVE.L D7,D1  
      MOVE.L D0,D2  
      MOVE.L D3,D4  
      JSR _Read(A6) 
      CMP.L D4,D0 : BNE.W error_access
    LAB_0013a:

    LEA 16(A3),A3
    CMPA.L A2,A3 
  BLS.W LAB_0012a 
  LAB_0014a:

  MOVE.L D7,D1 
JMP _Close(A6)


.do_GetaSprite:
  BSR.w free_currentSprite

  MOVE.w 10(A2),12(A3)
  MOVE.w 12(A2),14(A3)
  MOVE.w 2(A2),D7
  ADDQ.w #1,D7  
  MOVE.w D7,4(A3) 
  MOVE.w (A2),D6  
  SUBQ.w #1,D6  
  MOVE.w LAB_000C(PC),D0
  ADDQ.w #2,D0  
  LSR.w D0,D6   
  ADDQ.w #1,D6  
  CLR.w 8(A3)  
  CMPI.w #$0004,4(A2) : BNE.w LAB_0011
    BSET #7,8(A3) 
    ADD.w D6,D6   
  LAB_0011:

  MOVE.w D6,6(A3)  
  MOVE.b 1(A2),9(A3)
  MOVE.w D7,D0   
  MOVE.w LAB_000C(PC),D1
  LSL.w D1,D0  
  MOVE.w D0,10(A3) 
  MULU D6,D0  
  MOVEQ #2,D1 
  ALibJsr #globalalloc
  MOVE.l D0,(A3) 
  MOVEA.l 14(A2),A0
  MOVEA.l D0,A1  
  SUBQ.w #1,D6  
  LAB_0012:
    MOVE.l A0,-(A7)
    BSR.w LAB_0014 
    MOVEA.l (A7)+,A0
    TST.w 8(A3) : BPL.w LAB_0013
      MOVE.l A0,-(A7)  
      ADDA.w 22(A2),A0 
      ADDA.w 22(A2),A0 
      BSR.w LAB_0014  
      MOVEA.l (A7)+,A0
      SUBQ.w #1,D6
    LAB_0013:
    ADDA.w LAB_000B(PC),A0
  DBF D6,LAB_0012
RTS
                                                                                                                                                                                                                                         
LAB_0014:
  MOVE.w D7,D5  
  SUBQ.w #2,D5  
  MOVE.w _spriteMode(PC),D0 : BEQ.w LAB_0017
    SUBQ.w #1,D0 : BEQ.w LAB_0016 
      LAB_0015:
        MOVE.l (A0),(A1)+  ;4ce: 22d0
        MOVE.l 4(A0),(A1)+  ;4d0: 22e80004
        ADDA.w 22(A2),A0  ;4d4: d0ea0016
        MOVE.l (A0),(A1)+  ;4d8: 22d0
        MOVE.l 4(A0),(A1)+  ;4da: 22e80004
        SUBA.w 22(A2),A0  ;4de: 90ea0016
        ADDA.w 6(A2),A0  ;4e2: d0ea0006
      DBF D5,LAB_0015  ;4e6: 51cdffe6
      CLR.l (A1)+   ;4ea: 4299
      CLR.l (A1)+   ;4ec: 4299
      CLR.l (A1)+   ;4ee: 4299
      CLR.l (A1)+   ;4f0: 4299
      RTS    ;4f2: 4e75
    LAB_0016:
      MOVE.l (A0),(A1)+
      ADDA.w 22(A2),A0 
      MOVE.l (A0),(A1)+ 
      SUBA.w 22(A2),A0 
      ADDA.w 6(A2),A0 
    DBF D5,LAB_0016 
    CLR.l (A1)+  
    CLR.l (A1)+
    RTS    
  LAB_0017:
    MOVE.w (A0),(A1)+  ;50e: 32d0
    ADDA.w 22(A2),A0  ;510: d0ea0016
    MOVE.w (A0),(A1)+  ;514: 32d0
    SUBA.w 22(A2),A0  ;516: 90ea0016
    ADDA.w 6(A2),A0  ;51a: d0ea0006
  DBF D5,LAB_0017  ;51e: 51cdffee
  CLR.l (A1)+   ;522: 4299
RTS    ;524: 4e75

.free_currentSprite:
  MOVE.l (A3),D0 : BEQ.w LAB_0019
    MOVEA.l D0,A1
    CLR.l (A3)
    MOVE.w 4(A3),D0
    MOVE.w LAB_000C(PC),D1
    LSL.w D1,D0
    MULU 6(A3),D0  
    ALibJsr #globalfree
  LAB_0019:
RTS

.do_ShowSprite:   ; a3: current sprite, a2: coplist, d0: sprite#, d1: x, d2: y, d3: sprite channel
  SUB.w 12(A3),D1 : ADDI.w #$0080,D1
  SUB.w 14(A3),D2
  MOVE.w 32(A2),D0
  ADDQ.w #1,D0
  SUB.w D2,D0 : BLE.w LAB_0024

  MOVEQ #0,D4
  MOVE.w 4(A3),D5
  TST.w D2 : BPL.w LAB_001B
    ADD.w D2,D5 : BLE.w LAB_0024

    EXG D2,D4 
    NEG.w D4
    ASL.w #2,D4
  LAB_001B:

  CMP.w D5,D0 : BPL.w LAB_001C
    MOVE.w D0,D5
  LAB_001C:

  ADD.w (A2),D2
  BTST #4,3(A2) : BEQ.w LAB_001D
    ADDQ.w #2,D2
  LAB_001D:

  MOVEQ #0,D7
  MOVE.w D2,D6
  LSL.w #8,D6 : BCC.w LAB_001E
    MOVEQ #4,D7
  LAB_001E:

  LSR.w #1,D1 : BCC.w LAB_001F
    ADDQ.w #1,D7
  LAB_001F:

  MOVE.b D1,D6
  ADD.w D5,D2
  SUBQ.w #1,D2
  LSL.w #8,D2 : BCC.w LAB_0020
    ADDQ.w #2,D7
  LAB_0020:

  OR.w D2,D7
  TST.w 8(A3) : BPL.w LAB_0021
    BSET #7,D7
  LAB_0021:

  LSL.w #4,D3   ;5bc: e94b
  MOVEA.l 14(A2),A0  ;5be: 206a000e
  ADDA.w D3,A0   ;5c2: d0c3
  MOVE.l (A3),D0   ;5c4: 2013
  ADD.l D4,D0   ;5c6: d084
  MOVE.w 10(A3),D1  ;5c8: 322b000a
  EXT.l D1   ;5cc: 48c1
  MOVE.w 6(A3),D2  ;5ce: 342b0006
  SUBQ.w #1,D2   ;5d2: 5342
  LAB_0022:
    MOVE.w D6,2(A0)  ;5d4: 31460002
    MOVE.w D7,6(A0)  ;5d8: 31470006
    MOVE.w D0,14(A0)  ;5dc: 3140000e
    SWAP D0   ;5e0: 4840
    MOVE.w D0,10(A0)  ;5e2: 3140000a
    SWAP D0   ;5e6: 4840
    ADD.l D1,D0   ;5e8: d081
    LEA 16(A0),A0  ;5ea: 41e80010
    TST.w 8(A3) : BPL.w LAB_0023
      MOVE.w D6,2(A0)  ;5f6: 31460002
      MOVE.w D7,6(A0)  ;5fa: 31470006
      MOVE.w D0,14(A0) ;5fe: 3140000e
      SWAP D0          ;602: 4840
      MOVE.w D0,10(A0) ;604: 3140000a
      SWAP D0          ;608: 4840
      ADD.l D1,D0      ;60a: d081
      LEA 16(A0),A0    ;60c: 41e80010
      SUBQ.w #1,D2     ;610: 5342
    LAB_0023:
    ADDQ.w #8,D6       ;612: 5046
  DBF D2,LAB_0022      ;614: 51caffbe
  RTS                  ;618: 4e75

 LAB_0024:
  MOVE.w 6(A3),D2        ;61a: 342b0006
  SUBQ.w #1,D2           ;61e: 5342
  LSL.w #4,D3            ;620: e94b
  MOVEA.l 14(A2),A0      ;622: 206a000e
  ADDA.w D3,A0           ;626: d0c3
  LAB_0025:
    MOVE.w #$0000,2(A0)  ;628: 317c00000002
    MOVE.w #$0000,6(A0)  ;62e: 317c00000006
    LEA 16(A0),A0        ;634: 41e80010
    TST.w 8(A3) : BPL.w LAB_0026
      MOVE.w #$0000,2(A0)
      MOVE.w #$0000,6(A0)
      LEA 16(A0),A0
      SUBQ.w #1,D2
    LAB_0026:
  DBF D2,LAB_0025
RTS
                                                                                                                                                                                                                                                       
.do_InFrontB:
  MOVEA.l 26(A2),A1
  LSR.w #1,D0
  AND.w #$0007,D0
  LSL.w #3,D0
  MOVE.w (A1),D1
  AND.w #$0007,D1
  OR.w D1,D0
  MOVE.w D0,(A1)
RTS
                                                                                                                                                                                                                                                       
do_InFrontF:
  MOVEA.l 26(A2),A1
  LSR.w #1,D0
  AND.w #$0007,D0
  MOVE.w (A1),D1
  AND.w #$0038,D1
  OR.w D1,D0
  MOVE.w D0,(A1)
RTS
                                                                                                                                                                                                                                         
error_open:   MOVE.l #LAB_003B,D0 : TRAP #0
error_access: MOVE.l #LAB_003C,D0 : TRAP #0

 ;*******************************************************************
.errors:
LAB_0029: MOVE.l #LAB_0032,D0 : TRAP #0
LAB_002A: MOVE.l #LAB_0033,D0 : TRAP #0
LAB_002B: MOVE.l #LAB_0034,D0 : TRAP #0
LAB_002C: MOVE.l #LAB_0035,D0 : TRAP #0
LAB_002D: MOVE.l #LAB_0036,D0 : TRAP #0
LAB_002E: MOVE.l #LAB_0037,D0 : TRAP #0
LAB_002F: MOVE.l #LAB_0038,D0 : TRAP #0
LAB_0030: MOVE.l #LAB_0039,D0 : TRAP #0
LAB_0031: MOVE.l #LAB_003A,D0 : TRAP #0
LAB_0032: Dc.b "Uninitialized Shape",0
LAB_0033: Dc.b "Shape MUST be 4 or 16 colours",0
LAB_0034: Dc.b "Sprite too Wide",0
LAB_0035: Dc.b "Uninitialized Sprite",0
LAB_0036: Dc.b "Uninitialized Slice",0
LAB_0037: Dc.b "Sprite Channel Unavailable",0
LAB_0038: Dc.b "Slice does not support priority",0
LAB_0039: Dc.b "Sprite Channel not in range",0
LAB_003A: Dc.b "First Sprite must be lower than second",0
LAB_003B: Dc.b "Can't open Sprites file",0
LAB_003C: Dc.b "Error reading/writing Sprites file",0
                                                                                                                                                                                                     
.LAB_003D:
  MOVE.w LAB_000B(PC),D2
  ASL.w #5,D2
  TST.w (A2) : BEQ.w LAB_0029
  CMPI.w #$0002,4(A2) : BEQ.w LAB_003E
    CMPI.w #$0004,4(A2) : BNE.w LAB_002A
    ASL.w #1,D2
  LAB_003E:
  CMP.w (A2),D2 : BMI.w LAB_002B
RTS

.LAB_003F:
  TST.l (A3) : BEQ.w LAB_002C
  TST.w (A2) : BEQ.w LAB_002D
  MOVE.w D3,D7
  ADD.w 6(A3),D7
  CMP.w 6(A2),D7 : BHI.w LAB_002E
RTS

.LAB_0040:
  BTST #0,D0 : BNE.w LAB_0030
  CMPI.w #$0008,D0 : BHI.w LAB_0030
  TST.w (A2) : BEQ.w LAB_002D
  TST.l 26(A2) : BEQ.w LAB_002F
RTS

.LAB_0041:
  CMPA.l A2,A3 : BHI.w LAB_0031
RTS
