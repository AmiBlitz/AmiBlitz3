; XTRA
; Embedded .xtra Header
; 
; General Info
; -------------------------------------------------------
; ExePath         = "RAM:"
; ExeFile         = "h2AB3.exe"
; CreateIcon      = 0
; Residents       = ""
; 
; Compiler
; -------------------------------------------------------
; StringBuffer    = 10240
; MakeSmallest    = 0
; FuncOptimize    = 1
; Version         = 0.0.0
; NumberOfBuilds  = 7
; 
; Debugger
; -------------------------------------------------------
; CliArgs         = ""
; StackSize       = 32768
; RuntimeDebug    = 1
; DebugInfo       = 0
; CreateDbgFile   = 0
; OverflowCheck   = 0
; AssemblerCheck  = 1
; InterruptCheck  = 1
; AutoRun         = 1
; 
; Editor
; -------------------------------------------------------
; CursorLine      = 102
; CursorColumn    = 7
; LabelSearch     = ""
; LabelRemark     = 0
; LabelAll        = 0
; LabelCase       = 0
; LabelPosition   = 0
; 
; Blitz Objects
; -------------------------------------------------------
; Max File        = 5
; Max GadgetList  = 5
; Max Shape       = 100
; Max Bank        = 5
; Max MenuList    = 5
; Max GTList      = 20
; Max BitMap      = 10
; Max Screen      = 5
; Max IntuiFont   = 5
; Max Window      = 20
; Max Palette     = 32
; Max BlitzFont   = 4
; Max IconInfo    = 1
; Max MUIObject   = 50
; Max AsyncReq    = 4
; Max Req-Lib     = 5
; Max GTMenuList  = 5
; Max Console     = 5
; Max TCPSock     = 5
; Max Tape        = 5
; Max TagList     = 5
; Max Database    = 16
; Max Sound       = 10
; Max MedModule   = 8
; Max Buffer      = 10
; Max Queue       = 10
; Max Sprite      = 20
; Max Module      = 5
; Max Slice       = 10
; Max Page        = 4
; Max CopList     = 10
; Max PTModule    = 5
; Max Anim        = 10
; Max NChunky     = 50
; Max Chunky      = 20
; Max Stencil     = 5
; Max XBSound     = 10
; /XTRA
; 
; .h header file converter to a bb2 semi-readable file 
; 
; a lesson in cludge city by simon 
; 
; v1.0 
; ---
; rems out /* * / sections with ;
;
; converts structs to NewTypes 
;
; converts types in structs to bytes words and longs 
; (no string types as yet) 
;
; handles #define of constants
;
; converts #define "ascii" to Macro .. End Macro 
; (also replaces (x) parameter to '1) 
;
; ignores all ifndef logic because #include => xinclude 

Function$ getline{}
SHARED cp

    poo:
    a$ = Edit$(128) : cp = 1 
    a$ = Replace$(a$,";"," ") 
    a$ = Replace$(a$,Chr$(9)," ") 

    If Instr(a$,"/*") > 0             ;whole comment 
        If Instr(a$,"*/") > 0
            a$ = Replace$(a$ ,"/*" ,";/*") 
        Else 
            a$ = Replace$(a$ ,"/*" ,"**")
            NPrint "; ",a$
            blockloop: 
            a$ = Edit$(128) 
            If Instr(a$,"*/") = 0 
            NPrint ";", a$ 
            Pop If 
            Goto blockloop 
            End If 
            a$ = Replace$(a$,"*/","**") 
            NPrint ";",a$ 
            Pop If : Pop If 
            Goto poo 
        End If 
    End If 
    Function Return a$ 
End Function

Function$ nextword{a$}
SHARED cp
  
  b$ = ""

  While Mid$(a$, cp, 1) = " " : cp + 1 : Wend ;skip leading spaces 

  If Mid$(a$,cp,1) = ";" 
    Function Return Mid$(a$,cp)
  EndIf 

  While cp<=Len(a$) AND Mid$(a$,cp,1) <> Chr$(32) 
    b$ + Mid$(a$,cp,1) : cp + 1 
  Wend 
  Function Return b$ 
End Function 

; ----------------------------------------------------------------------------------
If NumPars <> 1 
  NPrint "Wrong Number of Parameters" 
  End 
End If 

CaseSense Off
n$ = Par$(1) : n$ = Replace$(n$ ,".h" ,"") + ".ab3"

If NOT ReadFile(0,Par$(1)) Then NPrint "Couldn't Open File" : End

If WriteFile(1, n$) 
  FileInput 0 : FileOutput 1

  While NOT Eof(0) 
    a$ = getline{}
    If a$ = "" Then NPrint a$

    If Left$(a$, 1) = ";" Then NPrint a$ : Goto dunline 
    c$ = nextword{a$} 
    If c$ = "struct" Then Gosub dostruct 
    If c$ = "#define" Then Gosub dodefine 
    If c$ = "#include" Then Gosub doinclude 
    dunline: 
  Wend 
EndIf
End

; ---------------------------------------------------------------

.doinclude: 
  v$ = nextword{a$}
  NPrint "XINCLUDE ",v$
Return 

; ---------------------------------------------------------------

.dodefine: 
  v$ = nextword{a$} 
  e$ = nextword{a$}
  DefaultOutput
  NPrint v$
  NPrint e$
  FileOutput 1
  If (e$ >= "a" AND e$ <= "z") OR (e$ => "A" AND e$ <= "Z") ; string define 
    ps = Instr(e$,".") : If ps Then e$ = Mid$(e$,ps + 1)
    f$ = nextword{a$} 
    NPrint "Macro ", v$, ":", e$, ":End Macro", Chr$(9), f$ 
  Else 
    If e$ = "\"
      s$ = "" : p = Instr(v$ ,"(") 
      If p Then s$ = Mid$(v$,p) : v$ = Left$(v$,p-l) 
      NPrint "Macro ",v$                                    ;cludge it man 

      a$ = Edit$(128) 
      If s$ <> "" Then a$ = Replace$(a$ ,s$,"'1") 
      a$ = Replace$(a$,"->" ,"\") 
      NPrint a$ 

      NPrint "End Macro" 
    Else 
      f$ = nextword{a$} ;numeric define 
      e$ = Replace$(e$,"0x","$") 
      e$ = Replace$(e$,"L","") 
      e$ = Replace$(e$,"L<<","LSL") 
      e$ = Replace$(e$,"L>>","LSR") 
      e$ = Replace$(e$,"<<","LSL") 
      e$ = Replace$(e$,">>","LSR") 
      If e$ = "" Then e$ = "-l" 
        NPrint "#", v$, "=", e$, Chr$(9), f$ 
      EndIf 
  EndIf 
Return
; --------------------------------------------------------------
.dostruct: 
  NPrint "NewType ," + nextword{a$} 
  u = 0 
  nxline: 
    a$ = getline{}
    If a$ = "" Then Goto nxline 
    If Left$(a$,1) = ";" Then NPrint a$: Goto nxline 
    c$ = nextword{a$}
    c$ = UCase$(c$) : t$ = "" 
    Select c$
    Case "}" 
        If u 
            u - 1
        Else 
            NPrint "End NewType"
            Return
        EndIf 
    Case "UNION" 
      u = 2 : Pop Select : Goto nxline 
    Case "UWORD"   : t$ = ".w" 
    Case "WORD"    : t$ = ".w" 
    Case "SHORT"   : t$ = ".w" 
    Case "USHORT"  : t$ = ".w" 
    Case "UNSIGNED": t$ = ".w" 
    Case "SIGNED"  : t$ = ".w" 
    Case "INT"     : t$ = ".w" ;is this default word on the amiga? 
    Case "VOID"    : t$ = ".w" 
    Case "BOOL"    : t$ = ".w"
    Case "BYTE"    : t$ = ".b" 
    Case "UBYTE"   : t$ = ".b" 
    Case "CHAR"    : t$ = ".b" 
    Case "LONG"    : t$ = ".l" 
    Case "ULONG"   : t$ = ".l" 
    Case "APTR"    : t$ = ".l" 
    Case "BPTR"    : t$ = ".l" 
    Case "CPTR"    : t$ = ".l" 
    Case "STRPTR"  : t$ = ".l" 
    Case "BSTR"    : t$ = ".l" 
    Case "FLOAT"   : t$ = ".f" 
    Case "STRUCT"  : t$ = "." + nextword{a$}
    End Select 

    If t$ <> "" 
      n$ = nextword{a$} 
      b = Instr(n$, "(") : b$ = "" 
      If u = 2 Then b$ = "(0)" : u - 1 
      If b Then b$ = Mid$(n$,b) : n$ = Left$(n$,b-1)
      NPrint " " + n$ + t$ + b$ + Chr$(9) + nextword{a$} 
    EndIf 
Goto nxline 
