; XTRA
; Embedded .xtra Header
; 
; General Info
; -------------------------------------------------------
; ExePath         = "Development:AmiBlitz3/Sourcecodes/Examples/OS library examples/ahi"
; ExeFile         = ""
; CreateIcon      = 1
; Residents       = "all.res"
; 
; Compiler
; -------------------------------------------------------
; StringBuffer    = 10240
; MakeSmallest    = 0
; FuncOptimize    = 1
; Version         = 0.0.0
; NumberOfBuilds  = 1
; 
; Debugger
; -------------------------------------------------------
; CliArgs         = ""
; StackSize       = 8191
; RuntimeDebug    = 1
; DebugInfo       = 0
; CreateDbgFile   = 0
; OverflowCheck   = 0
; AssemblerCheck  = 0
; InterruptCheck  = 1
; AutoRun         = 1
; 
; Editor
; -------------------------------------------------------
; CursorLine      = 18
; CursorColumn    = 25
; LabelSearch     = ""
; LabelRemark     = 0
; LabelAll        = 0
; LabelCase       = 0
; LabelPosition   = 0
; 
; Blitz Objects
; -------------------------------------------------------
; Max File        = 5
; Max GadgetList  = 5
; Max Shape       = 100
; Max Bank        = 5
; Max MenuList    = 5
; Max GTList      = 20
; Max Palette     = 4
; Max BitMap      = 10
; Max Screen      = 5
; Max IntuiFont   = 5
; Max Window      = 20
; Max BlitzFont   = 4
; Max IconInfo    = 1
; Max MUIObject   = 50
; Max AsyncReq    = 4
; Max Req-Lib     = 5
; Max GTMenuList  = 5
; Max Console     = 5
; Max TCPSock     = 5
; Max Tape        = 5
; Max TagList     = 5
; Max Database    = 16
; Max Sound       = 10
; Max MedModule   = 8
; Max Buffer      = 10
; Max Queue       = 10
; Max Sprite      = 20
; Max Module      = 5
; Max Slice       = 10
; Max Page        = 4
; Max CopList     = 10
; Max PTModule    = 5
; Max Anim        = 10
; Max NChunky     = 50
; Max Chunky      = 20
; Max Stencil     = 5
; Max XBSound     = 10
; /XTRA

; /*
; ** This program uses the device interface to sample sound data.
; ** The output is written to THE DEFAULT OUTPUT, make sure you
; ** start it with "RecordTest > mysample.raw" !
; */
;
; A C/C++ to AmiBlitz Adaptation
;
;     Done by Lorence Lombardo in 2008
;
; Complementing the work of AlphaSOUND
;
; Use "PlayTest.exe" to play back your sound.
;


INCLUDE "AHI_Include.ab3"

#SIGBREAKF_CTRL_C = 1 ASL 12

#RETURN_ERROR = 2
#RETURN_FAIL  = 1
#RETURN_OK    = 0

#FREQUENCY  = 16726
#MY_TYPE    = #AHIST_M8S
#BUFFERSIZE = 20000

DEFTYPE .MsgPort    *AHImp
DEFTYPE .AHIRequest *AHIio

AHIDevice.b = -1

;#My_Buffer1[#BUFFERSIZE]
;#My_Buffer2[#BUFFERSIZE]

*MyBuffer1 = AllocMem_(#BUFFERSIZE, 0)
*MyBuffer2 = AllocMem_(#BUFFERSIZE, 0)


Statement cleanup{rc.l}
  SHARED *AHIDevice, *AHIio, *AHImp, *MyBuffer1, *MyBuffer2

  If *AHIDevice=0
    CloseDevice_ *AHIio
  EndIf

  DeleteIORequest_ *AHIio
  DeleteMsgPort_   *AHImp

  ; The following added by Lombi

  FreeMem_ *MyBuffer1 ,#BUFFERSIZE
  FreeMem_ *MyBuffer2 ,#BUFFERSIZE

  If rc=1 Then NPrint " Failed...!!!"

  ; End Lombi ;)

End Statement


*p1=*MyBuffer1
*p2=*MyBuffer2

DEFTYPE .l signals, leng, priority

*AHImp = CreateMsgPort_()
If *AHImp

   *AHIio=CreateIORequest_(*AHImp, SizeOf .AHIRequest)
   If *AHIio
      *AHIio\ahir_Version = 4
      *AHIDevice=OpenDevice_(&AHINAME, 0, *AHIio, 0)
   EndIf

   If *AHIDevice <> 0
      cleanup{#RETURN_FAIL}
      End
   EndIf

   ; Play Buffer
   *AHIio\ahir_Std\io_Command  = #CMD_READ
   *AHIio\ahir_Std\io_Data     = *MyBuffer1
   *AHIio\ahir_Std\io_Length   = #BUFFERSIZE
   *AHIio\ahir_Std\io_Offset   = 0
   *AHIio\ahir_Frequency       = #FREQUENCY
   *AHIio\ahir_Type            = #MY_TYPE

   If NOT DoIO_(*AHIio)

      SetIoErr_ 0 : Ok=1

      While Ok=1

         leng.l=*AHIio\ahir_Std\io_Actual

         *AHIio\ahir_Std\io_Data     = *p2
         *AHIio\ahir_Std\io_Length   = #BUFFERSIZE
         *AHIio\ahir_Frequency       = #FREQUENCY
         *AHIio\ahir_Type            = #MY_TYPE

         SendIO_(*AHIio)

         If (Write_(Output_, *p1, leng))<1 Then Ok=0

         signals=Wait_(#SIGBREAKF_CTRL_C | (1 LSL *AHImp\mp_SigBit))

         ; Check For Ctrl-C AND abort If pressed
         If (signals & #SIGBREAKF_CTRL_C) <> 0
            SetIoErr_ 1 ;#ERROR_BREAK
            Ok=0 ; End
         EndIf

         If WaitIO_(*AHIio)
            SetIoErr_ #ERROR_READ_PROTECTED
            Ok=0 ; End
         EndIf

         If Ok=1  ; Not Abort
            ; Swap Buffer and Request pointers, and restart
            Exchange *p1, *p2  ; Easier and FASTER !!
         EndIf

      Wend

   EndIf

; Abort any pending iorequests

  AbortIO_ *AHIio
  WaitIO_  *AHIio


  ;If IoErr_
  ;  PrintFault_(IoErr(), argv[0] )
  ;  cleanup{#RETURN_ERROR}
  ;EndIf

  cleanup{#RETURN_OK}
EndIf

End


