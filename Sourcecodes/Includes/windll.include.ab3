; XTRA
; Embedded .xtra Header
; 
; General Info
; -------------------------------------------------------
; ExePath         = "/Bin"
; ExeFile         = "WinDLLDemo"
; CreateIcon      = 0
; Residents       = "all.res"
; 
; Compiler
; -------------------------------------------------------
; StringBuffer    = 10240
; MakeSmallest    = 1
; FuncOptimize    = 1
; Version         = 0.0.0
; NumberOfBuilds  = 44
; 
; Debugger
; -------------------------------------------------------
; CliArgs         = ""
; StackSize       = 8191
; RuntimeDebug    = 1
; DebugInfo       = 1
; CreateDbgFile   = 0
; OverflowCheck   = 0
; AssemblerCheck  = 0
; InterruptCheck  = 1
; AutoRun         = 1
; 
; Editor
; -------------------------------------------------------
; CursorLine      = 7
; CursorColumn    = 9
; LabelSearch     = ""
; LabelRemark     = 0
; LabelAll        = 0
; LabelPosition   = 0
; 
; Blitz Objects
; -------------------------------------------------------
; Max IconInfo    = 1
; Max NChunky     = 50
; Max MUIObject   = 50
; Max PTModule    = 5
; Max AsyncReq    = 4
; Max Req-Lib     = 5
; Max GTMenuList  = 5
; Max Console     = 5
; Max TCPSock     = 5
; Max XBSound     = 10
; Max Chunky      = 20
; Max File        = 5
; Max GadgetList  = 5
; Max Queue       = 10
; Max Screen      = 5
; Max Shape       = 100
; Max CopList     = 10
; Max Sprite      = 20
; Max Stencil     = 5
; Max Module      = 5
; Max Window      = 5
; Max Anim        = 10
; Max Sound       = 10
; Max Bank        = 5
; Max Buffer      = 10
; Max BitMap      = 10
; Max Slice       = 10
; Max Page        = 4
; Max Tape        = 5
; Max IntuiFont   = 5
; Max MedModule   = 8
; Max Palette     = 4
; Max MenuList    = 5
; Max BlitzFont   = 4
; Max GTList      = 5
; Max ChunkyBuffer= 2
; /XTRA

#WINUAE_OPENDLL          = 100
#WINUAE_GETNATIVEADDRESS = 101
#WINUAE_CALLNATIVE       = 102
#WINUAE_CLOSEDLL         = 103
#WINUAE_SCREENLOST       = 104
#WINUAE_MEMOFFSET        = 105

Macro WinUAE_Call
MOVEQ #`1,d0
JSR $f0ffc0
End Macro

Macro WinUAE_Test
TST.l $f0ffc0
End Macro

Macro dll_GetMemOffset
  !WinUAE_Call{#WINUAE_MEMOFFSET}
  `1=PutD0
End Macro

Function.l dll_GetMemOffset{}

  !dll_GetMemOffset{offset.l}
  Function Return offset

End Function

SHARED _winuae_memoffset.l
_winuae_memoffset = dll_GetMemOffset{}

Macro _68KP
  `1 - _winuae_memoffset
End Macro

Macro _x86P
  `1 + _winuae_memoffset
End Macro

Macro _x86Float
  Peek.l(&`1)
End Macro

Macro _68KFloat
  Peek.f(&`1)
End Macro

Macro dll_Close;{alib or dll pointer}
If (`1)
  GetReg d1,`1
  !WinUAE_Call{#WINUAE_CLOSEDLL}
End If
End Macro


Macro dll_Call ;{alib or dll pointer,par1[,...,par8}

CNIF `0 > 2 ; param1
GetD0 `3
MOVE.l d0,d1
CEND

CNIF `0 > 3 ; param2
GetD0 `4
MOVE.l d0,d2
CEND

CNIF `0 > 4 ; param3
GetD0 `5
MOVE.l d0,d3
CEND

CNIF `0 > 5 ; param4
GetD0 `6
MOVE.l d0,d4
CEND

CNIF `0 > 6 ; param5
GetD0 `7
MOVE.l d0,d5
CEND

CNIF `0 > 7 ; param6
GetD0 `8
MOVE.l d0,d6
CEND

CNIF `0 > 8 ; param7
GetD0 `9
MOVE.l d0,d7
CEND

GetD0 `1
MOVE.l d0,a0  ; DLL Pointer

!WinUAE_Call{#WINUAE_CALLNATIVE}
CNIF `0 > 1
`2=PutD0
CEND
End Macro

Macro dll_GetSymbolAddr ;{dll or alibbase,function or varname}
GetReg d1,`1
GetReg a0,`2
!WinUAE_Call{#WINUAE_GETNATIVEADDRESS}
`3=PutD0
End Macro

Macro dll_Open ;{return var for dll or alibbase,alibname}
MOVEQ #0,d0
!WinUAE_Test
;TST.l $f0ffc0
BEQ 'nowinuae
GetReg a0,`2
!WinUAE_Call{#WINUAE_OPENDLL}
`1=PutD0
'nowinuae
End Macro

Macro xendian32
( ( (`1 LSR 24) &$000000FF) | ( (`1 LSR 8) &$0000FF00)  | ( (`1 LSL 8) &$00FF0000) | ( (`1 LSL 24) &$FF000000) )
End Macro

Macro xendian16
( ( (`1 LSR 8) &$000000FF) | ( (`1 LSL 8) &$0000FF00) )
End Macro


Function.l dll_Open{dllname.s}
  opendll:
  !dll_Open{*dll.l,&dllname}
  Function Return *dll

End Function


Function.l dll_GetSymbolAddr{*dll.l,name.s}

  If (*dll)
    !dll_GetSymbolAddr{*dll,&name,*dlladdr.l}
  End If

  Function Return *dlladdr

End Function


Statement dll_Close{*dll.l}

  If *dll
    !dll_Close{*dll}
  End If

End Statement


Function.l dll_Call0{*dlladdr.l}
  !dll_Call{*dlladdr,ret.l}
  Function Return ret
End Function
 

Function.l dll_Call1{*dlladdr.l,param1.l}
  !dll_Call{*dlladdr,ret.l,param1}
  Function Return ret
End Function


Function.l dll_Call2{*dlladdr.l,param1.l,param2.l}
  !dll_Call{*dlladdr,ret.l,param1,param2}
  Function Return ret
End Function


Function.l dll_Call3{*dlladdr.l,param1.l,param2.l,param3.l}
  !dll_Call{*dlladdr,ret.l,param1,param2,param3}
  Function Return ret
End Function


Function.l dll_Call4{*dlladdr.l,param1.l,param2.l,param3.l,param4.l}
  !dll_Call{*dlladdr,ret.l,param1,param2,param3,param4}
  Function Return ret
End Function


Function.l dll_Call5{*dlladdr.l,param1.l,param2.l,param3.l,param4.l,param5.l}
  !dll_Call{*dlladdr,ret.l,param1,param2,param3,param4,param5}
  Function Return ret
End Function


Function.l dll_Call6{*dlladdr.l,param1.l,param2.l,param3.l,param4.l,param5.l,param6.l}
  !dll_Call{*dlladdr,ret.l,param1,param2,param3,param4,param5,param6}
  Function Return ret
End Function


Function.l dll_Call7{*dlladdr.l,param1.l,param2.l,param3.l,param4.l,param5.l,param6.l,param7.l}
  !dll_Call{*dlladdr,ret.l,param1,param2,param3,param4,param5,param6,param7}
  Function Return ret
End Function


Function.l dll_Call8{*dlladdr.l,param1.l,param2.l,param3.l,param4.l,param5.l,param6.l,param7.l,param8.l}

  GetD0 param8
  MOVE.l d0,a1

  !dll_Call{*dlladdr,ret.l,param1,param2,param3,param4,param5,param6,param7}
  Function Return ret
End Function


Function.l dll_Call9{*dlladdr.l,param1.l,param2.l,param3.l,param4.l,param5.l,param6.l,param7.l,param8.l,param9.l}

  GetD0 param8
  MOVE.l d0,a1
  GetD0 param9
  MOVE.l d0,a2

  !dll_Call{*dlladdr,ret.l,param1,param2,param3,param4,param5,param6,param7}
  Function Return ret
End Function


CNIF #__include=0
*myDLL.l = dll_Open{"my.dll"}
If *myDLL
  NPrint "Windows DLL opened!"
  dll_Close{*myDLL}
Else
  NPrint "Unable to open Windows DLL!"
End If
End

CEND

